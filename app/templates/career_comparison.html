{% extends "base.html" %}

{% block title %}Career Comparison Tool{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="text-center mb-4">
                <h1 class="display-4 text-primary">
                    <i class="fas fa-balance-scale me-3"></i>Career Comparison Tool
                </h1>
                <p class="lead text-muted">Compare careers side-by-side across key dimensions</p>
            </div>
        </div>
    </div>

    <!-- Career Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-search me-2"></i>Select Careers to Compare
                    </h5>
                    
                    <!-- Region Selection -->
                    <div class="mb-3">
                        <label class="form-label">Region:</label>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="region" id="global" value="global" checked>
                            <label class="btn btn-outline-primary" for="global">
                                <i class="fas fa-globe me-1"></i>Global
                            </label>
                            <input type="radio" class="btn-check" name="region" id="india" value="india">
                            <label class="btn btn-outline-primary" for="india">
                                <i class="fas fa-flag me-1"></i>India
                            </label>
                        </div>
                    </div>

                    <!-- Career Selection -->
                    <div class="mb-3">
                        <label class="form-label">Select Careers (2-5 careers):</label>
                        <div id="career-selection" class="row">
                            <!-- Career checkboxes will be populated here -->
                        </div>
                    </div>

                    <button id="compare-btn" class="btn btn-primary btn-lg" disabled>
                        <i class="fas fa-chart-bar me-2"></i>Compare Careers
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Results -->
    <div id="comparison-results" class="d-none">
        <!-- Overview Cards -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 class="text-center mb-4">
                    <i class="fas fa-chart-line me-2"></i>Comparison Overview
                </h3>
                <div id="overview-cards" class="row">
                    <!-- Overview cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Detailed Comparison Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-radar-chart me-2"></i>Multi-Dimensional Comparison
                        </h5>
                        <div id="comparison-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Metrics Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-table me-2"></i>Detailed Comparison
                        </h5>
                        <div class="table-responsive">
                            <table id="comparison-table" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Career</th>
                                        <th>Salary</th>
                                        <th>Stress Level</th>
                                        <th>Work-Life Balance</th>
                                        <th>Growth Rate</th>
                                        <th>Skills Complexity</th>
                                        <th>Job Outlook</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rankings -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-trophy me-2"></i>Rankings by Category
                        </h5>
                        <div id="rankings-section" class="row">
                            <!-- Rankings will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skills Comparison -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cogs me-2"></i>Required Skills Comparison
                        </h5>
                        <div id="skills-comparison">
                            <!-- Skills comparison will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Comparing careers...</p>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
class CareerComparison {
    constructor() {
        this.selectedCareers = new Set();
        this.availableCareers = [];
        this.currentRegion = 'global';
        this.init();
    }

    init() {
        this.loadAvailableCareers();
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Region change
        document.querySelectorAll('input[name="region"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.currentRegion = e.target.value;
                this.selectedCareers.clear();
                this.loadAvailableCareers();
                this.updateCompareButton();
            });
        });

        // Compare button
        document.getElementById('compare-btn').addEventListener('click', () => {
            this.compareCareers();
        });
    }

    async loadAvailableCareers() {
        try {
            const response = await fetch(`/api/career-comparison/careers?region=${this.currentRegion}`);
            const data = await response.json();
            this.availableCareers = data.careers || [];
            this.renderCareerSelection();
        } catch (error) {
            console.error('Error loading careers:', error);
        }
    }

    renderCareerSelection() {
        const container = document.getElementById('career-selection');
        container.innerHTML = '';

        this.availableCareers.forEach(career => {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-sm-6 mb-2';
            
            col.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input career-checkbox" type="checkbox" 
                           value="${career}" id="career-${career.replace(/\s+/g, '-')}">
                    <label class="form-check-label" for="career-${career.replace(/\s+/g, '-')}">
                        ${career}
                    </label>
                </div>
            `;
            
            container.appendChild(col);
        });

        // Add event listeners to checkboxes
        document.querySelectorAll('.career-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (this.selectedCareers.size >= 5) {
                        e.target.checked = false;
                        alert('Maximum 5 careers can be compared at once');
                        return;
                    }
                    this.selectedCareers.add(e.target.value);
                } else {
                    this.selectedCareers.delete(e.target.value);
                }
                this.updateCompareButton();
            });
        });
    }

    updateCompareButton() {
        const button = document.getElementById('compare-btn');
        const count = this.selectedCareers.size;
        
        if (count >= 2) {
            button.disabled = false;
            button.innerHTML = `<i class="fas fa-chart-bar me-2"></i>Compare ${count} Careers`;
        } else {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Select at least 2 careers';
        }
    }

    async compareCareers() {
        const careersArray = Array.from(this.selectedCareers);
        
        // Show loading
        document.getElementById('loading-spinner').classList.remove('d-none');
        document.getElementById('comparison-results').classList.add('d-none');

        try {
            const response = await fetch('/api/career-comparison/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    careers: careersArray,
                    region: this.currentRegion
                })
            });

            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
                return;
            }

            this.renderComparisonResults(data);
        } catch (error) {
            console.error('Error comparing careers:', error);
            alert('Error comparing careers. Please try again.');
        } finally {
            document.getElementById('loading-spinner').classList.add('d-none');
        }
    }

    renderComparisonResults(data) {
        // Show results section
        document.getElementById('comparison-results').classList.remove('d-none');
        
        // Render overview cards
        this.renderOverviewCards(data.careers);
        
        // Render comparison chart
        this.renderComparisonChart(data.careers);
        
        // Render detailed table
        this.renderComparisonTable(data.careers);
        
        // Render rankings
        this.renderRankings(data.rankings);
        
        // Render skills comparison
        this.renderSkillsComparison(data.careers);
        
        // Scroll to results
        document.getElementById('comparison-results').scrollIntoView({ behavior: 'smooth' });
    }

    renderOverviewCards(careers) {
        const container = document.getElementById('overview-cards');
        container.innerHTML = '';

        careers.forEach(career => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';
            
            const stressColor = this.getStressColor(career.stress_score);
            const balanceColor = this.getBalanceColor(career.work_life_score);
            
            col.innerHTML = `
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <h6 class="card-title text-primary">${career.name}</h6>
                        <div class="mb-2">
                            <small class="text-muted">Salary:</small>
                            <div class="fw-bold">${career.salary}</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Growth Rate:</small>
                            <div class="fw-bold text-success">${career.growth_rate}</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Stress Level:</small>
                            <div class="fw-bold" style="color: ${stressColor}">${career.stress_level}</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Work-Life Balance:</small>
                            <div class="fw-bold" style="color: ${balanceColor}">${career.work_life_balance}</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(col);
        });
    }

    renderComparisonChart(careers) {
        const traces = careers.map(career => ({
            type: 'scatterpolar',
            r: [
                career.salary_numeric / 1000, // Scale down for visualization
                6 - career.stress_score, // Invert stress (lower stress = better)
                career.work_life_score,
                career.growth_numeric,
                6 - career.skills_complexity // Invert complexity (lower = better for beginners)
            ],
            theta: ['Salary (K)', 'Low Stress', 'Work-Life Balance', 'Growth Rate', 'Easy Entry'],
            fill: 'toself',
            name: career.name,
            line: { width: 2 }
        }));

        const layout = {
            polar: {
                radialaxis: {
                    visible: true,
                    range: [0, 200] // Adjust based on your data range
                }
            },
            showlegend: true,
            title: 'Career Comparison Radar Chart',
            height: 500
        };

        Plotly.newPlot('comparison-chart', traces, layout);
    }

    renderComparisonTable(careers) {
        const tbody = document.querySelector('#comparison-table tbody');
        tbody.innerHTML = '';

        careers.forEach(career => {
            const row = document.createElement('tr');
            
            const stressColor = this.getStressColor(career.stress_score);
            const balanceColor = this.getBalanceColor(career.work_life_score);
            
            row.innerHTML = `
                <td class="fw-bold">${career.name}</td>
                <td>${career.salary}</td>
                <td style="color: ${stressColor}">${career.stress_level}</td>
                <td style="color: ${balanceColor}">${career.work_life_balance}</td>
                <td class="text-success">${career.growth_rate}</td>
                <td>${this.getComplexityText(career.skills_complexity)}</td>
                <td><small>${career.job_outlook}</small></td>
            `;
            
            tbody.appendChild(row);
        });
    }

    renderRankings(rankings) {
        const container = document.getElementById('rankings-section');
        container.innerHTML = '';

        const rankingCategories = [
            { key: 'salary', title: 'Highest Salary', icon: 'fas fa-dollar-sign', color: 'success' },
            { key: 'stress_level', title: 'Lowest Stress', icon: 'fas fa-heart', color: 'info' },
            { key: 'work_life_balance', title: 'Best Work-Life Balance', icon: 'fas fa-balance-scale', color: 'primary' },
            { key: 'growth_rate', title: 'Highest Growth', icon: 'fas fa-chart-line', color: 'warning' },
            { key: 'skills_complexity', title: 'Easiest Entry', icon: 'fas fa-door-open', color: 'secondary' }
        ];

        rankingCategories.forEach(category => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';
            
            const rankingList = rankings[category.key] || [];
            const listItems = rankingList.map((career, index) => 
                `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${career}
                    <span class="badge bg-${category.color} rounded-pill">${index + 1}</span>
                </li>`
            ).join('');
            
            col.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="${category.icon} me-2 text-${category.color}"></i>
                            ${category.title}
                        </h6>
                        <ul class="list-group list-group-flush">
                            ${listItems}
                        </ul>
                    </div>
                </div>
            `;
            
            container.appendChild(col);
        });
    }

    renderSkillsComparison(careers) {
        const container = document.getElementById('skills-comparison');
        container.innerHTML = '';

        careers.forEach(career => {
            const skillsHtml = career.required_skills.map(skill => 
                `<span class="badge bg-secondary me-1 mb-1">${skill.replace('_', ' ')}</span>`
            ).join('');
            
            const careerDiv = document.createElement('div');
            careerDiv.className = 'mb-3 p-3 border rounded';
            careerDiv.innerHTML = `
                <h6 class="text-primary">${career.name}</h6>
                <p class="mb-2"><strong>Required Skills (${career.required_skills.length}):</strong></p>
                <div>${skillsHtml}</div>
                <small class="text-muted mt-2 d-block">${career.description}</small>
            `;
            
            container.appendChild(careerDiv);
        });
    }

    getStressColor(stressScore) {
        const colors = ['#28a745', '#6c757d', '#ffc107', '#fd7e14', '#dc3545'];
        return colors[stressScore - 1] || '#6c757d';
    }

    getBalanceColor(balanceScore) {
        const colors = ['#dc3545', '#fd7e14', '#ffc107', '#6c757d', '#28a745'];
        return colors[balanceScore - 1] || '#6c757d';
    }

    getComplexityText(complexity) {
        const levels = ['Very Easy', 'Easy', 'Moderate', 'Hard', 'Very Hard'];
        return levels[complexity - 1] || 'Moderate';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new CareerComparison();
});
</script>
{% endblock %}